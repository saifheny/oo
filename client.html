<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…ÙŠÙ„ - Pro Version</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts (Cairo) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #f8fafc; 
            overflow: hidden; 
            touch-action: none; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; 
        }
        
        .safe-top { padding-top: max(20px, env(safe-area-inset-top)); }
        .safe-bottom { padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        
        #map { width: 100%; height: 100%; z-index: 0; position: absolute; top: 0; left: 0; }
        
        /* Map UI Elements */
        .map-picker-ui {
            pointer-events: none; position: absolute; inset: 0; z-index: 1000;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .center-pin-container {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -100%);
            display: flex; flex-direction: column; items-center; justify-center;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .map-moving .center-pin-container { transform: translate(-50%, -130%) scale(1.1); }
        .pin-bubble {
            background: #222; color: #fff; padding: 6px 12px; border-radius: 20px;
            font-size: 12px; font-weight: bold; margin-bottom: 8px; white-space: nowrap;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); opacity: 1; transition: opacity 0.2s;
        }
        .map-moving .pin-bubble { opacity: 0; }
        .pin-shadow {
            width: 12px; height: 4px; background: rgba(0,0,0,0.3); border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, 0);
            z-index: 999; pointer-events: none;
        }
        
        .floating-card {
            pointer-events: auto; background: white; border-radius: 24px 24px 0 0;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
        }

        .input-box {
            background: #f3f4f6; border: 1px solid #e5e7eb; transition: 0.3s;
        }
        .input-box:focus-within {
            background: #fff; border-color: #000; box-shadow: 0 0 0 4px rgba(0,0,0,0.05);
        }
        
        .modal-overlay {
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            z-index: 2000;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Map Theme Switcher Styles */
        .map-theme-btn {
            position: absolute; top: 60px; left: 16px; z-index: 900;
            background: white; width: 44px; height: 44px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .map-theme-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel" data-type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsnZdFrg-KlWFc0z6OgmXgBp6lPKf14fU",
        authDomain: "saifsa-b51f1.firebaseapp.com",
        databaseURL: "https://saifsa-b51f1-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "saifsa-b51f1",
        storageBucket: "saifsa-b51f1.firebasestorage.app",
        messagingSenderId: "41089917871",
        appId: "1:41089917871:web:fce49f6f23bd4f679b055a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø© ---
    const MAP_STYLES = {
        standard: { 
            name: "Ù‚ÙŠØ§Ø³ÙŠ", 
            url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
            preview: 'bg-gray-100'
        },
        satellite: { 
            name: "Ù‚Ù…Ø± ØµÙ†Ø§Ø¹ÙŠ", 
            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            preview: 'bg-green-800'
        },
        dark: { 
            name: "Ø¯Ø§ÙƒÙ†", 
            url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            preview: 'bg-gray-900'
        },
        light: { 
            name: "ÙØ§ØªØ­", 
            url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
            preview: 'bg-gray-200'
        },
        voyager: {
            name: "Ù…Ù„Ø§Ø­Ø©",
            url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
            preview: 'bg-blue-100'
        }
    };

    const Icon = ({ name, size = 24, className, onClick }) => {
        const ref = React.useRef(null);
        React.useEffect(() => {
            if (ref.current) {
                ref.current.innerHTML = '';
                const i = document.createElement('i');
                i.setAttribute('data-lucide', name);
                i.setAttribute('class', className || '');
                ref.current.appendChild(i);
                lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide', attrs: { width: size, height: size } });
            }
        }, [name, size, className]);
        return <span ref={ref} onClick={onClick} className={`flex items-center justify-center ${onClick ? 'cursor-pointer' : ''} ${className}`}></span>;
    };

    // --- Ù…ÙƒÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    const Login = ({ onLogin }) => {
        const [formData, setFormData] = React.useState({ name: '', phone: '' });
        const [errors, setErrors] = React.useState({ name: '', phone: '' });
        const [showConfirm, setShowConfirm] = React.useState(false);

        const validateAndProceed = () => {
            let newErrors = {};
            let isValid = true;
            const nameParts = formData.name.trim().split(/\s+/);
            if (nameParts.length < 3) { newErrors.name = "ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø«Ù„Ø§Ø«ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."; isValid = false; }
            const phoneRegex = /^01[0125][0-9]{8}$/;
            const cleanPhone = formData.phone.replace(/\D/g, ''); 
            if (!phoneRegex.test(cleanPhone)) { newErrors.phone = "ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…Ø­Ù…ÙˆÙ„ ØµØ­ÙŠØ­ (11 Ø±Ù‚Ù…)."; isValid = false; }
            setErrors(newErrors);
            if (isValid) { setFormData({ ...formData, phone: cleanPhone }); setShowConfirm(true); }
        };

        const handleFinalLogin = () => {
            onLogin({ ...formData, id: formData.phone, photo: "https://placehold.co/150x150/000/FFFFFF?text=" + formData.name.charAt(0) });
        };

        return (
            <div className="h-screen w-full flex flex-col justify-end p-6 bg-white safe-bottom relative">
                {showConfirm && (
                    <div className="absolute inset-0 modal-overlay flex items-center justify-center p-6 animate-[fadeIn_0.2s]">
                        <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl transform scale-100 animate-[scaleIn_0.2s]">
                            <div className="w-16 h-16 bg-yellow-50 rounded-full flex items-center justify-center mx-auto mb-4 text-yellow-500"><Icon name="alert-circle" size={32} /></div>
                            <h3 className="text-xl font-bold text-center mb-2">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù‚Ù…</h3>
                            <p className="text-center text-gray-500 mb-6 text-sm">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ØµØ­ÙŠØ­ØŸ<br/><span className="text-2xl font-black text-black block mt-2 tracking-widest">{formData.phone}</span></p>
                            <div className="flex gap-3">
                                <button onClick={() => setShowConfirm(false)} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200">ØªØ¹Ø¯ÙŠÙ„</button>
                                <button onClick={handleFinalLogin} className="flex-1 py-3 bg-black text-white font-bold rounded-xl shadow-lg">Ù†Ø¹Ù…ØŒ ØµØ­ÙŠØ­</button>
                            </div>
                        </div>
                    </div>
                )}
                <div className="flex-1 flex flex-col justify-center items-center">
                    <div className="w-24 h-24 bg-black rounded-[30px] flex items-center justify-center mb-8 shadow-2xl rotate-3 ring-4 ring-gray-50"><Icon name="map-pin" size={48} className="text-white"/></div>
                    <h1 className="text-4xl font-black text-gray-900 mb-2">ØªÙˆØµÙŠÙ„Ø©</h1>
                    <p className="text-gray-400 text-center px-8 font-medium">Ø³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„ØªØ¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ.</p>
                </div>
                <div className="w-full space-y-4 mb-4">
                    <div className={`bg-gray-50 p-4 rounded-2xl border transition ${errors.name ? 'border-red-500 bg-red-50' : 'border-gray-100 focus-within:border-black'}`}>
                        <label className={`block text-xs font-bold mb-1 ${errors.name ? 'text-red-500' : 'text-gray-400'}`}>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ø«Ù„Ø§Ø«ÙŠ)</label>
                        <input className="w-full bg-transparent font-bold text-lg outline-none text-gray-900 placeholder:text-gray-300" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ - Ø§Ù„Ø£Ø¨ - Ø§Ù„Ø¬Ø¯" value={formData.name} onChange={e => { setFormData({...formData, name:e.target.value}); if(errors.name) setErrors({...errors, name: ''}); }} />
                    </div>
                    {errors.name && <p className="text-red-500 text-xs font-bold px-2 -mt-2">{errors.name}</p>}
                    <div className={`bg-gray-50 p-4 rounded-2xl border transition ${errors.phone ? 'border-red-500 bg-red-50' : 'border-gray-100 focus-within:border-black'}`}>
                        <label className={`block text-xs font-bold mb-1 ${errors.phone ? 'text-red-500' : 'text-gray-400'}`}>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input className="w-full bg-transparent font-bold text-lg outline-none text-gray-900 placeholder:text-gray-300" placeholder="01xxxxxxxxx" type="tel" maxLength="11" value={formData.phone} onChange={e => { const val = e.target.value.replace(/\D/g, ''); setFormData({...formData, phone: val}); if(errors.phone) setErrors({...errors, phone: ''}); }} />
                    </div>
                    {errors.phone && <p className="text-red-500 text-xs font-bold px-2 -mt-2">{errors.phone}</p>}
                    <button onClick={validateAndProceed} className="w-full bg-black text-white py-4 rounded-2xl font-bold text-lg shadow-xl active:scale-95 transition mt-4">Ù…ØªØ§Ø¨Ø¹Ø©</button>
                </div>
            </div>
        );
    };

    // --- Dashboard ---
    const Dashboard = ({ client }) => {
        const [view, setView] = React.useState('HOME'); 
        const [pickup, setPickup] = React.useState(null);
        const [dropoff, setDropoff] = React.useState(null);
        
        // Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹
        const [pickerMode, setPickerMode] = React.useState('pickup'); 
        const [pickerAddress, setPickerAddress] = React.useState("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...");
        const [isMapMoving, setIsMapMoving] = React.useState(false);
        const [shortAddress, setShortAddress] = React.useState("Ø·Ø±ÙŠÙ‚ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");
        
        // Ø§Ù„Ø¨Ø­Ø«
        const [pickupText, setPickupText] = React.useState('');
        const [dropoffText, setDropoffText] = React.useState('');
        const [suggestions, setSuggestions] = React.useState([]);
        const [activeField, setActiveField] = React.useState(null);
        
        // Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙˆØ§Ù„Ø±Ø­Ù„Ø©
        const [availableDrivers, setAvailableDrivers] = React.useState([]);
        const [tripInfo, setTripInfo] = React.useState({ distance: 0, time: 0 });
        const [showMapPreview, setShowMapPreview] = React.useState(false); // Ø­Ø§Ù„Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†

        // Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        const [mapStyle, setMapStyle] = React.useState('standard');
        const [showStyleMenu, setShowStyleMenu] = React.useState(false);

        const mapRef = React.useRef(null);
        const tileLayerRef = React.useRef(null);
        const routingControlRef = React.useRef(null);
        const markersRef = React.useRef({});

        // --- ØªÙ‡ÙŠØ¦Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø© ---
        React.useEffect(() => {
            if (!mapRef.current) {
                mapRef.current = L.map('map', { zoomControl: false, attributionControl: false }).setView([30.0444, 31.2357], 15);
                
                // Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                tileLayerRef.current = L.tileLayer(MAP_STYLES.standard.url, { maxZoom: 19 }).addTo(mapRef.current);
                
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const { latitude, longitude } = pos.coords;
                    mapRef.current.setView([latitude, longitude], 16);
                    const addrData = await getAddressFromCoords(latitude, longitude);
                    setPickup({ lat: latitude, lng: longitude, address: addrData.full });
                    setPickupText(addrData.full);
                }, (err) => console.log(err), { enableHighAccuracy: true });

                mapRef.current.on('movestart', () => { if (view === 'MAP_PICKER') { setIsMapMoving(true); setPickerAddress("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯..."); } });
                mapRef.current.on('moveend', async () => {
                    if (view === 'MAP_PICKER') {
                        setIsMapMoving(false);
                        const center = mapRef.current.getCenter();
                        const addrData = await getAddressFromCoords(center.lat, center.lng);
                        setPickerAddress(addrData.full);
                        setShortAddress(addrData.short);
                    }
                });
            }
        }, [view]);

        // ØªØºÙŠÙŠØ± Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        React.useEffect(() => {
            if (mapRef.current && tileLayerRef.current) {
                mapRef.current.removeLayer(tileLayerRef.current);
                tileLayerRef.current = L.tileLayer(MAP_STYLES[mapStyle].url, { maxZoom: 19 }).addTo(mapRef.current);
            }
        }, [mapStyle]);

        const getAddressFromCoords = async (lat, lng) => {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar&addressdetails=1`);
                const data = await response.json();
                const a = data.address || {};
                const short = a.road || a.pedestrian || a.suburb || "Ø·Ø±ÙŠÙ‚ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
                const full = data.display_name.split(',').slice(0, 3).join('ØŒ ');
                return { short, full: full || "Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©" };
            } catch (e) { return { short: "Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯", full: "Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©" }; }
        };

        const handleSearch = async (text, field) => {
            if (field === 'pickup') setPickupText(text); else setDropoffText(text);
            setActiveField(field);
            if (text.length > 2) {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${text}&countrycodes=eg&accept-language=ar&limit=5`);
                    const data = await res.json();
                    setSuggestions(data);
                } catch(e) {}
            } else { setSuggestions([]); }
        };

        const selectSuggestion = (item) => {
            const lat = parseFloat(item.lat);
            const lng = parseFloat(item.lon);
            const name = item.display_name.split(',').slice(0, 2).join('ØŒ ');
            if (activeField === 'pickup') { setPickup({ lat, lng, address: name }); setPickupText(name); } 
            else { setDropoff({ lat, lng, address: name }); setDropoffText(name); }
            setSuggestions([]);
            document.activeElement.blur();
        };

        React.useEffect(() => {
            if (!mapRef.current) return;
            setTimeout(() => mapRef.current.invalidateSize(), 100);
            if (routingControlRef.current) { mapRef.current.removeControl(routingControlRef.current); routingControlRef.current = null; }
            Object.values(markersRef.current).forEach(m => m.remove());
            
            if (view === 'MAP_PICKER') {
                const target = pickerMode === 'pickup' ? pickup : dropoff;
                if (target) mapRef.current.setView([target.lat, target.lng], 16);
                else if (pickup) mapRef.current.setView([pickup.lat, pickup.lng], 16);
            } 
            else if (view === 'DRIVER_SELECT' && pickup && dropoff) {
                // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø±
                const pIcon = L.divIcon({ className: 'p-marker', html: '<div class="w-3 h-3 bg-black rounded-full border-2 border-white box-content shadow-md"></div>' });
                const dIcon = L.divIcon({ className: 'd-marker', html: '<div class="w-3 h-3 bg-black rounded-sm border-2 border-white box-content shadow-md"></div>' });
                markersRef.current.p = L.marker([pickup.lat, pickup.lng], {icon: pIcon}).addTo(mapRef.current);
                markersRef.current.d = L.marker([dropoff.lat, dropoff.lng], {icon: dIcon}).addTo(mapRef.current);
                routingControlRef.current = L.Routing.control({
                    waypoints: [L.latLng(pickup.lat, pickup.lng), L.latLng(dropoff.lat, dropoff.lng)],
                    lineOptions: { styles: [{ color: 'black', opacity: 0.8, weight: 5 }] },
                    createMarker: () => null, addWaypoints: false, draggableWaypoints: false, show: false, fitSelectedRoutes: true
                }).on('routesfound', function(e) {
                    const routes = e.routes;
                    setTripInfo({ distance: (routes[0].summary.totalDistance / 1000).toFixed(1), time: Math.round(routes[0].summary.totalTime / 60) });
                }).addTo(mapRef.current);
            }
        }, [view, pickerMode]);

        const openMapPicker = (mode) => { setPickerMode(mode); setView('MAP_PICKER'); };
        const confirmMapPicker = () => {
            if (!mapRef.current) return;
            const center = mapRef.current.getCenter();
            const locationData = { lat: center.lat, lng: center.lng, address: pickerAddress };
            if (pickerMode === 'pickup') { setPickup(locationData); setPickupText(pickerAddress); } 
            else { setDropoff(locationData); setDropoffText(pickerAddress); }
            setView('LOCATION_INPUT');
        };

        const handleSearchDrivers = () => {
            if(!pickup || !dropoff) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©");
            setView('DRIVER_SELECT');
            setShowMapPreview(false); // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹
            get(ref(db, 'drivers')).then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const list = Object.keys(data).map(k => ({ id: k, ...data[k] })).filter(d => d.status === 'online');
                    setAvailableDrivers(list.length ? list : getDemoDrivers()); 
                } else {
                    setAvailableDrivers(getDemoDrivers());
                }
            });
        };

        const getDemoDrivers = () => [
            {id: '1', name: 'Ø³ÙŠÙ Ø¹ØµØ§Ù…', phone: '0100000001', photo: 'https://placehold.co/100', rating: 4.9, car: 'ØªÙˆÙƒ ØªÙˆÙƒ Ø£Ø­Ù…Ø±'},
            {id: '2', name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…ÙˆØ¯', phone: '0100000002', photo: 'https://placehold.co/100', rating: 4.5, car: 'ØªÙˆÙƒ ØªÙˆÙƒ Ø£Ø³ÙˆØ¯'},
            {id: '3', name: 'ÙƒØ±ÙŠÙ… Ø¹Ù„ÙŠ', phone: '0100000003', photo: 'https://placehold.co/100', rating: 5.0, car: 'ØªÙˆÙƒ ØªÙˆÙƒ Ø£Ø²Ø±Ù‚'},
        ];

        // --- Views ---

        const MapThemeSwitcher = () => (
            <>
                <button onClick={() => setShowStyleMenu(!showStyleMenu)} className="map-theme-btn" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø©">
                    <Icon name="layers" size={20} className="text-gray-700"/>
                </button>
                
                {showStyleMenu && (
                    <div className="absolute top-[110px] left-4 z-[900] bg-white rounded-2xl p-3 shadow-xl w-48 animate-[scaleIn_0.15s] origin-top-left">
                        <div className="text-xs font-bold text-gray-400 mb-2 px-1">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</div>
                        <div className="space-y-2">
                            {Object.entries(MAP_STYLES).map(([key, style]) => (
                                <div key={key} onClick={() => { setMapStyle(key); setShowStyleMenu(false); }} 
                                     className={`flex items-center gap-3 p-2 rounded-lg cursor-pointer transition ${mapStyle === key ? 'bg-black text-white' : 'hover:bg-gray-100'}`}>
                                    <div className={`w-8 h-8 rounded-md border border-gray-300 ${style.preview}`}></div>
                                    <span className="text-sm font-bold">{style.name}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </>
        );

        const DriverSelectionView = () => (
            <div className={`absolute inset-0 z-50 transition-transform duration-300 ${view === 'DRIVER_SELECT' ? 'translate-x-0' : 'translate-x-full'}`}>
                
                {/* 1. ØµÙØ­Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† */}
                <div className={`absolute inset-0 bg-gray-50 flex flex-col transition-transform duration-300 ${showMapPreview ? 'translate-y-full' : 'translate-y-0'}`}>
                    {/* Header */}
                    <div className="safe-top bg-white px-6 pb-4 pt-4 shadow-sm z-10">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-black">Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ù‚Ø±ÙŠØ¨ÙŠÙ†</h2>
                            {/* Ø²Ø± Ø§Ù„Ø®Ø±ÙŠØ·Ø© - ÙŠØ±Ø¬Ø¹Ù†Ø§ Ù„Ù„Ù…Ø³Ø§Ø± */}
                            <button onClick={() => setShowMapPreview(true)} className="flex items-center gap-2 bg-gray-100 px-4 py-2 rounded-full font-bold text-sm hover:bg-gray-200 transition">
                                <Icon name="map" size={16}/> Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                            </button>
                        </div>
                        <div className="flex items-center gap-2 text-sm text-gray-500 bg-gray-50 p-3 rounded-xl">
                            <Icon name="navigation" size={14}/>
                            <span>Ø§Ù„Ù…Ø³Ø§ÙØ©: {tripInfo.distance} ÙƒÙ…</span>
                            <span className="mx-1">â€¢</span>
                            <span>Ø§Ù„ÙˆÙ‚Øª: {tripInfo.time} Ø¯Ù‚ÙŠÙ‚Ø©</span>
                        </div>
                    </div>

                    {/* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar">
                        {availableDrivers.map(d => (
                            <div key={d.id} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-4">
                                <div className="flex items-center gap-4">
                                    <div className="relative">
                                        <img src={d.photo} className="w-16 h-16 rounded-full bg-gray-100 object-cover border-2 border-white shadow-sm" />
                                        <div className="absolute -bottom-1 -right-1 bg-green-500 text-white text-[10px] px-1.5 py-0.5 rounded-full border-2 border-white">Ù…ØªØ§Ø­</div>
                                    </div>
                                    <div className="flex-1">
                                        <div className="flex justify-between items-start">
                                            <h3 className="font-bold text-lg text-gray-900">{d.name}</h3>
                                            <div className="flex items-center gap-1 bg-yellow-50 px-2 py-1 rounded-lg">
                                                <Icon name="star" size={12} className="fill-yellow-400 text-yellow-400"/>
                                                <span className="text-xs font-bold text-yellow-700">{d.rating}</span>
                                            </div>
                                        </div>
                                        <div className="text-sm text-gray-500 mt-0.5">{d.car}</div>
                                    </div>
                                </div>
                                
                                <div className="flex items-center gap-3 mt-2 pt-4 border-t border-gray-50">
                                    <button className="flex-1 py-3 bg-black text-white rounded-xl font-bold text-sm shadow-md active:scale-95 transition">Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©</button>
                                    <a href={`tel:${d.phone}`} className="w-12 h-12 flex items-center justify-center bg-gray-100 rounded-xl text-gray-700 hover:bg-gray-200"><Icon name="phone" size={20}/></a>
                                </div>
                            </div>
                        ))}
                        <div className="h-10 text-center text-gray-400 text-sm flex items-center justify-center gap-2">
                            <div className="w-2 h-2 bg-gray-300 rounded-full animate-bounce"></div>
                            Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø²ÙŠØ¯...
                        </div>
                    </div>

                    <div className="p-4 bg-white border-t border-gray-100 safe-bottom">
                         <button onClick={() => setView('LOCATION_INPUT')} className="w-full py-4 text-red-500 font-bold bg-red-50 rounded-xl hover:bg-red-100 transition">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø«</button>
                    </div>
                </div>

                {/* 2. ÙˆØ¶Ø¹ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© (ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯Ù…Ø§ Ù†Ø¶ØºØ· Ø²Ø± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©) */}
                {showMapPreview && (
                    <div className="absolute inset-0 pointer-events-none flex flex-col justify-end pb-safe">
                        {/* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ø§Ø¦Ù… */}
                        <div className="absolute top-0 left-0 right-0 p-4 safe-top pointer-events-auto flex justify-center">
                            <button onClick={() => setShowMapPreview(false)} className="bg-black text-white px-6 py-3 rounded-full shadow-xl font-bold flex items-center gap-2 animate-[slideDown_0.3s]">
                                <Icon name="list" size={18}/> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
                            </button>
                        </div>
                        
                        {/* ÙƒØ§Ø±Øª Ù…Ù„Ø®Øµ ØµØºÙŠØ± Ø¨Ø§Ù„Ø£Ø³ÙÙ„ */}
                        <div className="m-4 bg-white p-4 rounded-2xl shadow-xl pointer-events-auto animate-[slideUp_0.3s]">
                            <div className="flex justify-between items-center">
                                <div>
                                    <div className="font-bold text-gray-900">{availableDrivers.length} Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ†</div>
                                    <div className="text-xs text-gray-500">Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚ ÙŠØ¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†</div>
                                </div>
                                <button onClick={() => setShowMapPreview(false)} className="bg-black text-white px-4 py-2 rounded-xl text-sm font-bold">Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );

        // Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ (Home, Input, Picker) ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠØŒ Ù„ÙƒÙ† Ù†Ø¶ÙŠÙ MapThemeSwitcher Ù„Ù„Ø®Ø±ÙŠØ·Ø©
        const HomeView = () => (
            <div className={`absolute inset-0 bg-white z-20 flex flex-col transition-transform duration-300 ${view === 'HOME' ? 'translate-x-0' : '-translate-x-full'}`}>
                <div className="safe-top px-6 pt-6 flex justify-between items-center">
                    <div className="flex items-center gap-3">
                         <div className="w-10 h-10 rounded-full bg-gray-200 overflow-hidden"><img src={client.photo} className="w-full h-full object-cover"/></div>
                         <div className="font-bold text-lg">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ {client.name.split(' ')[0]} ğŸ‘‹</div>
                    </div>
                    <div className="bg-gray-100 p-2 rounded-full"><Icon name="bell" size={20}/></div>
                </div>
                <div className="px-6 mt-6">
                    <div onClick={() => setView('LOCATION_INPUT')} className="bg-black text-white p-5 rounded-3xl shadow-xl flex items-center justify-between cursor-pointer active:scale-98 transition transform">
                        <div className="flex flex-col gap-1"><span className="text-2xl font-bold">Ø¥Ù„Ù‰ Ø£ÙŠÙ† ØªØ±ÙŠØ¯ Ø§Ù„Ø°Ù‡Ø§Ø¨ØŸ</span><span className="text-gray-400 text-sm">Ø§Ø¶ØºØ· Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ¬Ù‡ØªÙƒ</span></div>
                        <div className="bg-gray-800 p-3 rounded-full"><Icon name="arrow-left" size={24}/></div>
                    </div>
                </div>
            </div>
        );

        const MapPickerView = () => (
            <div className={`absolute inset-0 z-50 flex flex-col pointer-events-none ${view === 'MAP_PICKER' ? 'visible' : 'invisible'}`}>
                <div className={`absolute top-0 left-0 right-0 z-[60] safe-top px-4 pt-4 flex items-center justify-between transition-opacity duration-300 ${view === 'MAP_PICKER' ? 'opacity-100' : 'opacity-0'}`}>
                    <button onClick={() => setView('LOCATION_INPUT')} className="bg-white p-3 rounded-full shadow-lg text-gray-800 pointer-events-auto active:scale-90 transition border border-gray-100"><Icon name="arrow-right" size={24}/></button>
                </div>
                <div className={`map-picker-ui ${isMapMoving ? 'map-moving' : ''}`}>
                    <div className="center-pin-container">
                        <div className="flex flex-col items-center">
                            <div className="pin-bubble">{isMapMoving ? '...' : shortAddress}</div>
                            <div className="relative z-10">
                                <Icon name="map-pin" size={44} className={`drop-shadow-xl ${pickerMode === 'pickup' ? 'text-black fill-blue-500' : 'text-black fill-red-500'}`} strokeWidth={1.5} />
                                <div className="absolute top-[38%] left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-white rounded-full shadow-sm"></div>
                            </div>
                            <div className="w-0.5 h-4 bg-black/50 mt-[-2px]"></div>
                        </div>
                    </div>
                    <div className="pin-shadow"></div>
                </div>
                <div className={`absolute bottom-0 left-0 right-0 z-[60] pointer-events-none transition-transform duration-300 ${view === 'MAP_PICKER' ? 'translate-y-0' : 'translate-y-full'}`}>
                    <div className="floating-card safe-bottom p-6 pt-6 pointer-events-auto">
                        <div className="flex flex-col gap-4">
                            <div className="flex items-center gap-4">
                                <div className={`p-3 rounded-full ${pickerMode === 'pickup' ? 'bg-blue-50 text-blue-600' : 'bg-red-50 text-red-600'}`}><Icon name={isMapMoving ? "loader-2" : "map-pin"} size={24} className={isMapMoving ? "animate-spin" : ""}/></div>
                                <div className="flex-1"><div className="text-xs text-gray-400 font-bold mb-0.5">{pickerMode === 'pickup' ? 'Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚' : 'Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„'}</div><div className="font-bold text-gray-900 text-base leading-snug line-clamp-2">{pickerAddress}</div></div>
                            </div>
                            <button onClick={confirmMapPicker} disabled={isMapMoving} className="w-full bg-black text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition disabled:opacity-70 disabled:scale-100 flex items-center justify-center gap-2"><span>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</span><Icon name="check" size={20}/></button>
                        </div>
                    </div>
                </div>
            </div>
        );

        const LocationInputView = () => (
            <div className={`absolute inset-0 bg-white z-30 flex flex-col transition-transform duration-300 ${view === 'LOCATION_INPUT' ? 'translate-x-0' : 'translate-x-full'}`}>
                <div className="safe-top p-4 flex items-center gap-4 border-b border-gray-50">
                    <button onClick={() => setView('HOME')} className="p-2 rounded-full hover:bg-gray-100 transition"><Icon name="arrow-right" size={24}/></button>
                    <h2 className="text-lg font-bold">ØªØ®Ø·ÙŠØ· Ø§Ù„Ø±Ø­Ù„Ø©</h2>
                </div>
                <div className="p-6">
                    <div className="flex flex-col gap-4 relative">
                        <div className="absolute right-[28px] top-[40px] bottom-[40px] w-0.5 bg-gray-200 border-l border-dashed border-gray-300"></div>
                        <div className="flex items-center gap-3 relative z-10">
                             <div className="w-8 flex justify-center mt-1"><div className="w-3 h-3 bg-blue-500 rounded-full ring-4 ring-blue-50"></div></div>
                             <div className="flex-1 input-box rounded-xl p-1 flex items-center"><input className="flex-1 bg-transparent p-3 text-sm font-bold outline-none" value={pickupText} onChange={(e) => handleSearch(e.target.value, 'pickup')} placeholder="Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ" /><button onClick={() => openMapPicker('pickup')} className="p-3 text-gray-400 hover:text-blue-600"><Icon name="map" size={20}/></button></div>
                        </div>
                        <div className="flex items-center gap-3 relative z-10">
                             <div className="w-8 flex justify-center mt-1"><div className="w-3 h-3 bg-red-500 rounded-sm ring-4 ring-red-50"></div></div>
                             <div className="flex-1 input-box rounded-xl p-1 flex items-center"><input className="flex-1 bg-transparent p-3 text-sm font-bold outline-none" value={dropoffText} onChange={(e) => handleSearch(e.target.value, 'dropoff')} placeholder="Ø¥Ù„Ù‰ Ø£ÙŠÙ†ØŸ" autoFocus /><button onClick={() => openMapPicker('dropoff')} className="p-3 text-gray-400 hover:text-red-600"><Icon name="map" size={20}/></button></div>
                        </div>
                    </div>
                </div>
                <div className="flex-1 overflow-y-auto px-6 pb-20 no-scrollbar">
                    {suggestions.map((item, i) => (
                        <div key={i} className="flex items-center gap-4 p-4 mb-2 bg-gray-50 rounded-2xl cursor-pointer active:bg-gray-100 transition" onClick={() => selectSuggestion(item)}>
                            <div className="bg-white p-2 rounded-full shadow-sm text-gray-600"><Icon name="map-pin" size={18}/></div>
                            <div><div className="font-bold text-sm text-gray-800">{item.display_name.split(',')[0]}</div><div className="text-xs text-gray-500 truncate w-60">{item.display_name}</div></div>
                        </div>
                    ))}
                </div>
                <div className="absolute bottom-0 left-0 right-0 p-6 safe-bottom bg-gradient-to-t from-white via-white to-transparent">
                    <button onClick={handleSearchDrivers} disabled={!pickup || !dropoff} className="w-full bg-black text-white py-4 rounded-xl font-bold text-lg shadow-xl active:scale-95 transition disabled:opacity-50 disabled:scale-100">ÙŠÙ„Ø§ Ø¨ÙŠÙ†Ø§ (Ø¨Ø­Ø«)</button>
                </div>
            </div>
        );

        return (
            <div className="relative h-screen w-full bg-gray-50 overflow-hidden">
                <div id="map"></div>
                
                {/* Ø²Ø± ØªØºÙŠÙŠØ± Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ ÙˆØ§Ø¬Ù‡Ø§Øª Ù…Ø¹ÙŠÙ†Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø²Ø­Ø§Ù…) */}
                {['HOME', 'MAP_PICKER', 'DRIVER_SELECT'].includes(view) && !showMapPreview && <MapThemeSwitcher />}
                
                <HomeView />
                <LocationInputView />
                <MapPickerView />
                <DriverSelectionView />
            </div>
        );
    };

    const App = () => {
        const [clientData, setClientData] = React.useState(null);
        React.useEffect(() => { const s = localStorage.getItem('client_app_v2'); if (s) setClientData(JSON.parse(s)); }, []);
        return clientData ? <Dashboard client={clientData} /> : <Login onLogin={(d) => { setClientData(d); localStorage.setItem('client_app_v2', JSON.stringify(d)); }} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
