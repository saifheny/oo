<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>عميل - بحث وملاحة</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts (Cairo) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; overflow: hidden; touch-action: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(12px); border-top: 1px solid rgba(0,0,0,0.05); box-shadow: 0 -4px 25px rgba(0, 0, 0, 0.15); transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1); }
        .map-btn { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s; }
        .map-btn:active { transform: scale(0.95); }
        .leaflet-routing-container { display: none !important; }
        .bottom-sheet { max-height: 80vh; overflow-y: auto; border-radius: 20px 20px 0 0; }
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(2); opacity: 0; } }
        .user-pulse::before { content: ''; position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: rgba(59, 130, 246, 0.5); border-radius: 50%; z-index: -1; animation: pulse-ring 2s infinite; }
        
        /* تنسيق نتائج البحث */
        .search-results { max-height: 200px; overflow-y: auto; background: white; border-radius: 0 0 12px 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .search-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; }
        .search-item:hover { background-color: #f3f4f6; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel" data-type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onDisconnect, update, push, onValue, remove, query, get, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsnZdFrg-KlWFc0z6OgmXgBp6lPKf14fU",
        authDomain: "saifsa-b51f1.firebaseapp.com",
        databaseURL: "https://saifsa-b51f1-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "saifsa-b51f1",
        storageBucket: "saifsa-b51f1.firebasestorage.app",
        messagingSenderId: "41089917871",
        appId: "1:41089917871:web:fce49f6f23bd4f679b055a",
        measurementId: "G-4K733KS3CP"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const Icon = ({ name, size = 24, color = "currentColor", className }) => {
        const ref = React.useRef(null);
        React.useEffect(() => {
            if (ref.current) {
                ref.current.innerHTML = '';
                const i = document.createElement('i');
                i.setAttribute('data-lucide', name);
                i.setAttribute('class', className || '');
                ref.current.appendChild(i);
                lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, stroke: color } });
            }
        }, [name, size, color, className]);
        return <span ref={ref} className="flex items-center justify-center"></span>;
    };

    const Dashboard = ({ client }) => {
        const [step, setStep] = React.useState('select_pickup');
        const [mapType, setMapType] = React.useState('satellite'); 
        const [pickup, setPickup] = React.useState(null);
        const [dropoff, setDropoff] = React.useState(null);
        const [availableDrivers, setAvailableDrivers] = React.useState([]);
        const [viewingDriver, setViewingDriver] = React.useState(null);
        const [activeTrip, setActiveTrip] = React.useState(null);
        const [driverLocation, setDriverLocation] = React.useState(null);
        const [driverProposedPrice, setDriverProposedPrice] = React.useState(null);
        const [tripInfo, setTripInfo] = React.useState({ distance: 0, time: 0 });
        
        // حالة البحث
        const [searchQuery, setSearchQuery] = React.useState('');
        const [searchResults, setSearchResults] = React.useState([]);
        
        const [isPanelMinimized, setIsPanelMinimized] = React.useState(false);

        const mapRef = React.useRef(null);
        const layersRef = React.useRef({});
        const markersRef = React.useRef({});
        const routingControlRef = React.useRef(null);
        const currentWatchId = React.useRef(null);

        // --- 1. الخريطة والموقع ---
        React.useEffect(() => {
            if (!mapRef.current) {
                mapRef.current = L.map('map', { zoomControl: false }).setView([30.0444, 31.2357], 15);
                
                // الطبقات (تم إضافة طبقة الأسماء Labels)
                layersRef.current.street = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap' });
                layersRef.current.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles © Esri' });
                layersRef.current.labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { attribution: '© CartoDB', pane: 'shadowPane' }); // طبقة شفافة للأسماء
                
                layersRef.current.satellite.addTo(mapRef.current);
                layersRef.current.labels.addTo(mapRef.current); // إضافة الأسماء فوق القمر الصناعي
                
                if (navigator.geolocation) {
                    currentWatchId.current = navigator.geolocation.watchPosition(
                        (pos) => {
                            const { latitude, longitude } = pos.coords;
                            
                            // تعيين نقطة البداية تلقائياً عند فتح التطبيق
                            if (!pickup && step === 'select_pickup') {
                                setPickup({ lat: latitude, lng: longitude, address: "موقعي الحالي" });
                                mapRef.current.flyTo([latitude, longitude], 18);
                            }
                            
                            updateClientMarker(latitude, longitude); 
                        },
                        (err) => console.warn('GPS Error'),
                        { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
                    );
                }
            }
            return () => { if (currentWatchId.current) navigator.geolocation.clearWatch(currentWatchId.current); };
        }, [pickup, step]); // Added pickup to dependencies to ensure auto-set works only once

        // --- 2. تبديل نوع الخريطة (مع الحفاظ على الأسماء) ---
        React.useEffect(() => {
            if (!mapRef.current) return;
            if (mapType === 'satellite') {
                if(mapRef.current.hasLayer(layersRef.current.street)) mapRef.current.removeLayer(layersRef.current.street);
                if(!mapRef.current.hasLayer(layersRef.current.satellite)) mapRef.current.addLayer(layersRef.current.satellite);
                if(!mapRef.current.hasLayer(layersRef.current.labels)) mapRef.current.addLayer(layersRef.current.labels); // تأكد من وجود الأسماء
            } else {
                if(mapRef.current.hasLayer(layersRef.current.satellite)) mapRef.current.removeLayer(layersRef.current.satellite);
                if(mapRef.current.hasLayer(layersRef.current.labels)) mapRef.current.removeLayer(layersRef.current.labels); // إزالة الأسماء في وضع الشوارع لأنها مدمجة
                if(!mapRef.current.hasLayer(layersRef.current.street)) mapRef.current.addLayer(layersRef.current.street);
            }
        }, [mapType]);

        // --- 3. تحديث الماركر والمسار ---
        React.useEffect(() => {
            if (!mapRef.current) return;
            if (markersRef.current.pickup) { markersRef.current.pickup.remove(); markersRef.current.pickup = null; }
            if (markersRef.current.dropoff) { markersRef.current.dropoff.remove(); markersRef.current.dropoff = null; }
            if (routingControlRef.current) { mapRef.current.removeControl(routingControlRef.current); routingControlRef.current = null; }

            if (pickup) {
                const icon = L.divIcon({ className: 'p-marker', html: '<div class="w-8 h-8 bg-emerald-600 text-white flex items-center justify-center rounded-full border-2 border-white font-bold shadow-md">من</div>', iconSize: [32, 32] });
                markersRef.current.pickup = L.marker([pickup.lat, pickup.lng], { icon }).addTo(mapRef.current);
            }
            if (dropoff) {
                const icon = L.divIcon({ className: 'd-marker', html: '<div class="w-8 h-8 bg-red-600 text-white flex items-center justify-center rounded-full border-2 border-white font-bold shadow-md">إلى</div>', iconSize: [32, 32] });
                markersRef.current.dropoff = L.marker([dropoff.lat, dropoff.lng], { icon }).addTo(mapRef.current);
            }

            if (pickup && dropoff) {
                routingControlRef.current = L.Routing.control({
                    waypoints: [L.latLng(pickup.lat, pickup.lng), L.latLng(dropoff.lat, dropoff.lng)],
                    lineOptions: { styles: [{ color: '#3B82F6', opacity: 0.8, weight: 6 }] },
                    createMarker: function() { return null; },
                    addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true, showAlternatives: false
                }).on('routesfound', function(e) {
                    const routes = e.routes;
                    setTripInfo({ distance: (routes[0].summary.totalDistance / 1000).toFixed(1), time: Math.round(routes[0].summary.totalTime / 60) });
                }).addTo(mapRef.current);
            }
        }, [pickup, dropoff]);

        // --- 4. النقر اليدوي ---
        React.useEffect(() => {
            if (!mapRef.current) return;
            const handler = (e) => {
                if (step === 'select_pickup') {
                    setPickup({ lat: e.latlng.lat, lng: e.latlng.lng, address: `موقع محدد` });
                    setStep('select_dropoff');
                } else if (step === 'select_dropoff') {
                    setDropoff({ lat: e.latlng.lat, lng: e.latlng.lng, address: `موقع محدد` });
                    setStep('confirm_route_preview'); 
                }
            };
            mapRef.current.on('click', handler);
            return () => mapRef.current.off('click', handler);
        }, [step]);

        // --- وظيفة البحث ---
        const handleSearch = async (e) => {
            e.preventDefault();
            if (!searchQuery) return;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${searchQuery}&countrycodes=eg`);
                const data = await response.json();
                setSearchResults(data);
            } catch (error) {
                console.error("Search error", error);
            }
        };

        const selectSearchResult = (result) => {
            const lat = parseFloat(result.lat);
            const lng = parseFloat(result.lon);
            const address = result.display_name.split(',')[0]; // أخذ الاسم الأول فقط للاختصار

            if (step === 'select_pickup') {
                setPickup({ lat, lng, address });
                mapRef.current.setView([lat, lng], 16);
                setStep('select_dropoff');
            } else {
                setDropoff({ lat, lng, address });
                mapRef.current.setView([lat, lng], 16);
                setStep('confirm_route_preview');
            }
            setSearchResults([]);
            setSearchQuery('');
        };

        // --- بقية الدوال (جلب السائقين، الطلب) ---
        const fetchAvailableDrivers = () => {
            setAvailableDrivers([]);
            get(ref(db, 'drivers')).then((snapshot) => {
                const data = snapshot.val();
                if (!data) return alert("لا يوجد سائقين حالياً");
                const list = Object.keys(data).map(k => ({ id: k, ...data[k] })).filter(d => d.status === 'online');
                setAvailableDrivers(list);
                list.forEach(d => updateDriverMarker(d));
                setStep('select_driver_list');
            });
        };

        const sendRequestToDriver = () => {
            if (!viewingDriver) return;
            setStep('awaiting_driver_price');
            setIsPanelMinimized(false);
            const requestId = push(ref(db, 'requests')).key;
            const tripData = {
                requestId, clientName: client.name, clientPhone: client.phone,
                pickupLat: pickup.lat, pickupLng: pickup.lng, pickupAddress: pickup.address,
                dropoffLat: dropoff.lat, dropoffLng: dropoff.lng, dropoffAddress: dropoff.address,
                driverId: viewingDriver.id, status: 'waiting_for_price', timestamp: Date.now()
            };
            set(ref(db, `requests/${viewingDriver.id}`), tripData).then(() => { setActiveTrip(tripData); });
        };

        React.useEffect(() => {
            if (!activeTrip?.driverId) return;
            const rRef = ref(db, `requests/${activeTrip.driverId}`);
            const unsub = onValue(rRef, (snap) => {
                const req = snap.val();
                if (req?.status === 'price_proposed') {
                    setDriverProposedPrice(req.finalPrice);
                    setStep('awaiting_client_decision');
                    setIsPanelMinimized(false);
                } else if (req?.status === 'accepted') {
                    setStep('trip_active');
                    setIsPanelMinimized(false);
                } else if (!req && step === 'trip_active') {
                    alert("الرحلة انتهت!");
                    resetApp();
                }
            });
            return () => unsub();
        }, [activeTrip?.driverId, step]);

        const updateClientMarker = (lat, lng) => {
            if (!mapRef.current) return;
            if (markersRef.current.client) markersRef.current.client.setLatLng([lat, lng]);
            else markersRef.current.client = L.circleMarker([lat, lng], { radius: 8, fillColor: '#3B82F6', color: 'white', fillOpacity: 1 }).addTo(mapRef.current);
        };
        
        const updateDriverMarker = (d) => {
            if (!mapRef.current) return;
            const iconHtml = `<div class="relative w-10 h-10"><img src="${d.photo}" class="w-full h-full rounded-full border-2 border-yellow-500 object-cover shadow-lg bg-white"></div>`;
            const icon = L.divIcon({ className: 'dr-marker', html: iconHtml, iconSize: [40, 40] });
            if (markersRef.current[`d_${d.id}`]) markersRef.current[`d_${d.id}`].setLatLng([d.lat, d.lng]).setIcon(icon);
            else markersRef.current[`d_${d.id}`] = L.marker([d.lat, d.lng], { icon }).addTo(mapRef.current);
        };

        const resetApp = () => {
            setStep('select_pickup');
            setPickup(null);
            setDropoff(null);
            setActiveTrip(null);
            setViewingDriver(null);
            if (routingControlRef.current) { mapRef.current.removeControl(routingControlRef.current); routingControlRef.current = null; }
            Object.keys(markersRef.current).forEach(k => { if(k.startsWith('d_')) { markersRef.current[k].remove(); delete markersRef.current[k]; } });
        };

        // --- UI Rendering ---
        let bottomContent = null;
        let showPanel = true;

        // مربع البحث (يظهر في خطوة الاختيار)
        const SearchBar = () => (
            <div className="mb-4 relative">
                <form onSubmit={handleSearch} className="flex items-center gap-2 bg-gray-100 p-2 rounded-xl border border-gray-200">
                    <Icon name="search" size={20} className="text-gray-500"/>
                    <input 
                        type="text" 
                        className="bg-transparent flex-1 outline-none text-sm" 
                        placeholder={step === 'select_pickup' ? "ابحث عن نقطة الانطلاق..." : "ابحث عن الوجهة..."}
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                    {searchQuery && <button type="submit" className="bg-blue-600 text-white p-1 rounded-lg text-xs">بحث</button>}
                </form>
                {searchResults.length > 0 && (
                    <div className="search-results absolute w-full z-50">
                        {searchResults.map((r, i) => (
                            <div key={i} className="search-item" onClick={() => selectSearchResult(r)}>
                                {r.display_name}
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );

        if (step === 'select_pickup') {
            bottomContent = (
                <div>
                    <h3 className="font-bold mb-2">1. حدد الانطلاق</h3>
                    <SearchBar />
                    <div className="flex items-center gap-3 p-3 bg-blue-50 rounded-xl border border-blue-100 mb-2">
                        <Icon name="map-pin" className="text-blue-600"/>
                        <span className="text-sm font-bold">{pickup ? pickup.address : 'جاري تحديد موقعك...'}</span>
                    </div>
                    {pickup && <button onClick={() => setStep('select_dropoff')} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-bold">تأكيد الانطلاق</button>}
                </div>
            );
        } else if (step === 'select_dropoff') {
            bottomContent = (
                <div>
                    <h3 className="font-bold mb-2">2. حدد الوجهة</h3>
                    <SearchBar />
                    <div className="flex items-center gap-3 p-3 bg-red-50 rounded-xl border border-red-100 mb-2">
                        <Icon name="flag" className="text-red-600"/>
                        <span className="text-sm font-bold">{dropoff ? dropoff.address : 'اضغط على الخريطة...'}</span>
                    </div>
                </div>
            );
        } else if (step === 'confirm_route_preview') {
            bottomContent = (
                <div className="flex flex-col gap-4">
                    <div className="flex items-center justify-between">
                        <div className="text-lg font-bold">تفاصيل المسار</div>
                        <div className="text-sm font-bold bg-gray-100 px-2 py-1 rounded text-gray-600">
                            {tripInfo.distance} كم • {tripInfo.time} دقيقة
                        </div>
                    </div>
                    <div className="space-y-2 text-sm bg-gray-50 p-3 rounded-xl">
                        <div className="flex gap-2"><Icon name="circle" size={16} className="text-emerald-500"/><span>من: {pickup.address}</span></div>
                        <div className="flex gap-2"><Icon name="square" size={16} className="text-red-500"/><span>إلى: {dropoff.address}</span></div>
                    </div>
                    <button onClick={fetchAvailableDrivers} className="w-full py-4 bg-emerald-600 text-white rounded-xl font-bold shadow-lg">
                        ابحث عن كابتن
                    </button>
                </div>
            );
        } else if (step === 'select_driver_list') {
            bottomContent = (
                <div className="flex flex-col h-full">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-lg font-bold text-gray-800">الكباتن المتاحين ({availableDrivers.length})</h2>
                        <button onClick={() => setStep('confirm_route_preview')} className="text-sm text-red-500 font-bold">رجوع</button>
                    </div>
                    <div className="overflow-y-auto" style={{ maxHeight: '50vh' }}>
                        {availableDrivers.length === 0 ? (
                            <div className="text-center text-gray-500 py-8">لا يوجد سائقين في منطقتك حالياً.</div>
                        ) : (
                            availableDrivers.map(d => (
                                <div key={d.id} onClick={() => { setViewingDriver(d); setStep('view_driver_profile'); }} className="bg-white p-3 rounded-xl border border-gray-200 mb-3 flex items-center gap-3 cursor-pointer hover:border-emerald-500 transition">
                                    <img src={d.photo} className="w-14 h-14 rounded-full object-cover border" />
                                    <div className="flex-1">
                                        <div className="font-bold text-gray-800">{d.name}</div>
                                        <div className="text-xs text-gray-500">{d.plate}</div>
                                    </div>
                                    <div className="bg-gray-100 p-2 rounded-full">
                                        <Icon name="chevron-left" size={20} className="text-gray-600"/>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        } else if (step === 'view_driver_profile' && viewingDriver) {
            bottomContent = (
                <div className="animate-slide-up">
                    <button onClick={() => setStep('select_driver_list')} className="mb-4 text-gray-500 flex items-center gap-1 text-sm"><Icon name="arrow-right" size={16}/> عودة للقائمة</button>
                    <div className="flex flex-col items-center mb-6">
                        <div className="relative w-24 h-24 mb-3">
                            <img src={viewingDriver.photo} className="w-full h-full rounded-full object-cover border-4 border-white shadow-lg" />
                            <div className="absolute bottom-0 right-0 bg-green-500 w-6 h-6 rounded-full border-2 border-white"></div>
                        </div>
                        <h2 className="text-2xl font-bold text-gray-800">{viewingDriver.name}</h2>
                        <p className="text-gray-500 bg-gray-100 px-3 py-1 rounded-full text-sm mt-1">{viewingDriver.plate}</p>
                    </div>
                    <div className="grid grid-cols-2 gap-3 mb-6">
                        <div className="bg-gray-50 p-3 rounded-xl text-center"><div className="text-gray-400 text-xs">المركبة</div><div className="font-bold text-gray-800">توك توك</div></div>
                        <div className="bg-gray-50 p-3 rounded-xl text-center"><div className="text-gray-400 text-xs">التقييم</div><div className="font-bold text-yellow-600">5.0 ★</div></div>
                    </div>
                    <button onClick={sendRequestToDriver} className="w-full py-4 bg-emerald-600 text-white rounded-xl font-bold shadow-lg text-lg flex justify-center items-center gap-2">طلب تسعير الرحلة <Icon name="send" size={20}/></button>
                </div>
            );
        } else if (step === 'awaiting_driver_price') {
            bottomContent = (
                <div className="text-center py-4">
                    <div className="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3 animate-pulse"><Icon name="clock" size={32} className="text-yellow-600"/></div>
                    <h3 className="text-lg font-bold mb-1">بانتظار تسعير الكابتن...</h3>
                    <p className="text-sm text-gray-500 mb-6">سيقوم {viewingDriver.name} بمراجعة المسار وتقديم عرض سعر.</p>
                    <button onClick={resetApp} className="text-red-500 font-bold text-sm border border-red-200 px-4 py-2 rounded-lg">إلغاء الطلب</button>
                </div>
            );
        } else if (step === 'awaiting_client_decision') {
            bottomContent = (
                <div className="text-center">
                    <div className="text-sm text-gray-500 mb-2">عرض السعر من الكابتن</div>
                    <div className="text-5xl font-extrabold text-emerald-600 mb-6">{driverProposedPrice} <span className="text-lg text-gray-400">ج.م</span></div>
                    <div className="flex gap-3">
                        <button onClick={() => { remove(ref(db, `requests/${activeTrip.driverId}`)); alert("تم الرفض"); resetApp(); }} className="flex-1 py-3 bg-red-100 text-red-600 rounded-xl font-bold">رفض</button>
                        <button onClick={() => { update(ref(db, `requests/${activeTrip.driverId}`), { status: 'accepted' }); }} className="flex-[2] py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg">موافقة</button>
                    </div>
                </div>
            );
        } else if (step === 'trip_active') {
            bottomContent = (
                <div>
                    <div className="bg-emerald-50 border border-emerald-200 p-3 rounded-xl mb-4 flex items-center justify-between">
                        <span className="text-emerald-800 font-bold">الرحلة جارية</span>
                        <span className="bg-white px-2 py-1 rounded text-emerald-600 font-bold text-sm">{driverProposedPrice} ج.م</span>
                    </div>
                    <div className="flex gap-2">
                        <a href={`tel:${viewingDriver.phone}`} className="flex-1 py-3 bg-green-100 text-green-700 rounded-xl font-bold flex justify-center items-center gap-2"><Icon name="phone" size={18}/> اتصل</a>
                        <button onClick={() => { remove(ref(db, `requests/${activeTrip.driverId}`)); resetApp(); }} className="flex-1 py-3 bg-red-100 text-red-700 rounded-xl font-bold">إلغاء</button>
                    </div>
                </div>
            );
        } else { showPanel = false; }

        return (
            <div className="relative h-screen w-full bg-gray-100 overflow-hidden">
                <div id="map" className="w-full h-full z-0"></div>
                <div className="absolute top-4 left-4 right-4 z-[1000]">
                    <div className="glass-panel rounded-2xl p-3 flex justify-between items-center">
                        <div className="flex items-center gap-2"><img src={client.photo} className="w-8 h-8 rounded-full border" /><span className="font-bold text-sm text-gray-700">{client.name}</span></div>
                        <button onClick={() => setMapType(mapType === 'street' ? 'satellite' : 'street')} className="bg-white p-2 rounded-xl shadow-sm"><Icon name={mapType === 'street' ? 'map' : 'globe'} size={20} className="text-gray-600" /></button>
                    </div>
                </div>
                {showPanel && (
                    <div className={`absolute bottom-0 left-0 right-0 z-[2000] glass-panel rounded-t-3xl transition-transform duration-300 bottom-sheet ${isPanelMinimized ? 'translate-y-[85%]' : 'translate-y-0'}`}>
                        <div className="w-full h-8 flex items-center justify-center cursor-pointer bg-white/50" onClick={() => setIsPanelMinimized(!isPanelMinimized)}>
                            <div className="w-12 h-1.5 bg-gray-300 rounded-full"></div>
                        </div>
                        <div className="p-5 pb-8 pt-2 bg-white">
                            <div className="flex justify-end mb-1">
                                <button onClick={() => setIsPanelMinimized(!isPanelMinimized)} className="text-gray-400 p-1"><Icon name={isPanelMinimized ? "chevron-up" : "chevron-down"} size={20} /></button>
                            </div>
                            {bottomContent}
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const Login = ({ onLogin }) => {
        const [formData, setFormData] = React.useState({ name: '', phone: '' });
        const [img, setImg] = React.useState(null);
        const onImg = (e) => { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=()=>setImg(r.result); r.readAsDataURL(f); }};
        return (
            <div className="h-screen w-full flex items-center justify-center p-4 login-bg relative">
                <div className="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
                <div className="bg-white/95 backdrop-blur-md p-8 rounded-3xl shadow-2xl w-full max-w-md relative z-10">
                    <h1 className="text-2xl font-bold text-center mb-6 text-gray-800">تطبيق العميل</h1>
                    <div className="relative w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full overflow-hidden border-4 border-gray-200 group cursor-pointer">
                        {img ? <img src={img} className="w-full h-full object-cover"/> : <div className="flex items-center justify-center h-full text-gray-400"><Icon name="camera" size={32}/></div>}
                        <input type="file" onChange={onImg} className="absolute inset-0 opacity-0 cursor-pointer"/>
                    </div>
                    <input placeholder="الاسم" className="w-full p-4 mb-3 border rounded-xl bg-gray-50 focus:bg-white" onChange={e=>setFormData({...formData, name:e.target.value})}/>
                    <input placeholder="رقم الهاتف" className="w-full p-4 mb-6 border rounded-xl bg-gray-50 focus:bg-white" onChange={e=>setFormData({...formData, phone:e.target.value})}/>
                    <button onClick={(e) => { e.preventDefault(); if(formData.name) onLogin({...formData, id: formData.phone.replace(/\D/g,''), photo: img || "https://placehold.co/150x150/000/FFFFFF?text=C"}); }} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold shadow-lg">تسجيل الدخول</button>
                </div>
            </div>
        );
    };

    const App = () => {
        const [clientData, setClientData] = React.useState(null);
        React.useEffect(() => { const s = localStorage.getItem('client_app_real'); if (s) setClientData(JSON.parse(s)); }, []);
        return clientData ? <Dashboard client={clientData} /> : <Login onLogin={(d) => { setClientData(d); localStorage.setItem('client_app_real', JSON.stringify(d)); }} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
