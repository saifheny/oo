<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>كابتن - التوجيه المرحلي</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts (Cairo) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f4f6;
            overflow: hidden;
            touch-action: none;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.15);
            border-radius: 24px 24px 0 0;
            transition: transform 0.3s ease;
        }
        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 16px;
        }
        .map-btn {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .map-btn:active { transform: scale(0.95); }
        
        .leaflet-routing-container { display: none !important; }

        .driver-marker-container {
            position: relative;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .heading-ring {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%;
            border: 2px solid #10B981;
            transition: transform 0.3s linear;
            pointer-events: none;
        }
        .heading-arrow {
            position: absolute;
            top: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 0; 
            height: 0; 
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 10px solid #10B981;
        }
        .driver-img {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            z-index: 2;
            background: white;
        }
        .bottom-sheet-content {
            max-height: 70vh;
            overflow-y: auto;
            padding-bottom: 20px;
        }
        
        /* Animation for Modal */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: fadeIn 0.2s ease-out forwards; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel" data-type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onDisconnect, update, push, onValue, remove, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsnZdFrg-KlWFc0z6OgmXgBp6lPKf14fU",
        authDomain: "saifsa-b51f1.firebaseapp.com",
        databaseURL: "https://saifsa-b51f1-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "saifsa-b51f1",
        storageBucket: "saifsa-b51f1.firebasestorage.app",
        messagingSenderId: "41089917871",
        appId: "1:41089917871:web:fce49f6f23bd4f679b055a",
        measurementId: "G-4K733KS3CP"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const Icon = ({ name, size = 24, color = "currentColor", className }) => {
        const ref = React.useRef(null);
        React.useEffect(() => {
            if (ref.current) {
                ref.current.innerHTML = '';
                const i = document.createElement('i');
                i.setAttribute('data-lucide', name);
                i.setAttribute('class', className || '');
                ref.current.appendChild(i);
                lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, stroke: color } });
            }
        }, [name, size, color, className]);
        return <span ref={ref} className="flex items-center justify-center"></span>;
    };

    // --- Edit Profile Modal ---
    const EditProfileModal = ({ driver, onClose, onSave }) => {
        const [formData, setFormData] = React.useState({ ...driver });
        const [img, setImg] = React.useState(driver.photo);

        const onImg = (e) => {
            const f = e.target.files[0];
            if (f) {
                const r = new FileReader();
                r.onload = () => {
                    setImg(r.result);
                    setFormData(prev => ({ ...prev, photo: r.result }));
                };
                r.readAsDataURL(f);
            }
        };

        return (
            <div className="fixed inset-0 z-[3000] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
                <div className="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl modal-animate relative">
                    <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-gray-100 rounded-full hover:bg-gray-200">
                        <Icon name="x" size={20} className="text-gray-600"/>
                    </button>
                    
                    <h2 className="text-xl font-bold mb-6 text-center text-gray-800">تعديل الملف الشخصي</h2>
                    
                    <div className="relative w-28 h-28 mx-auto mb-8 group">
                        <img src={img} className="w-full h-full rounded-full object-cover border-4 border-emerald-500 shadow-md" />
                        <label className="absolute bottom-0 right-0 bg-gray-800 text-white p-2.5 rounded-full cursor-pointer hover:bg-gray-700 shadow-lg transition transform hover:scale-110">
                            <Icon name="camera" size={18} />
                            <input type="file" onChange={onImg} className="hidden" accept="image/*" />
                        </label>
                    </div>

                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-bold text-gray-600 mb-1">الاسم</label>
                            <input 
                                value={formData.name} 
                                onChange={e => setFormData({...formData, name: e.target.value})}
                                className="w-full p-3 border rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 outline-none transition"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-600 mb-1">رقم الهاتف</label>
                            <input 
                                value={formData.phone} 
                                onChange={e => setFormData({...formData, phone: e.target.value})}
                                className="w-full p-3 border rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 outline-none transition"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-600 mb-1">رقم اللوحة</label>
                            <input 
                                value={formData.plate} 
                                onChange={e => setFormData({...formData, plate: e.target.value})}
                                className="w-full p-3 border rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 outline-none transition"
                            />
                        </div>
                    </div>

                    <div className="flex gap-3 mt-8">
                        <button onClick={onClose} className="flex-1 py-3.5 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition">إلغاء</button>
                        <button onClick={() => onSave(formData)} className="flex-1 py-3.5 bg-emerald-600 text-white rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition">حفظ التغييرات</button>
                    </div>
                </div>
            </div>
        );
    };

    // --- Dashboard Component ---
    const Dashboard = ({ driver, updateDriverData }) => {
        const [isOnline, setIsOnline] = React.useState(true);
        const [mapType, setMapType] = React.useState('satellite'); 
        const [incomingRequest, setIncomingRequest] = React.useState(null);
        const [activeTrip, setActiveTrip] = React.useState(null);
        const [tripStage, setTripStage] = React.useState('pickup'); 
        const [totalEarnings, setTotalEarnings] = React.useState(driver.totalEarnings || 0);
        const [currentLocation, setCurrentLocation] = React.useState(null);
        const [priceInput, setPriceInput] = React.useState(''); 
        const [tripInfo, setTripInfo] = React.useState({ distance: 0, time: 0 });
        const [showEditProfile, setShowEditProfile] = React.useState(false); // حالة المودال

        const mapRef = React.useRef(null);
        const layersRef = React.useRef({});
        const driverMarkerRef = React.useRef(null);
        const tripMarkersRef = React.useRef({});
        const routingControlRef = React.useRef(null);

        // 1. تهيئة الخريطة
        React.useEffect(() => {
            if (!mapRef.current) {
                mapRef.current = L.map('map', { zoomControl: false }).setView([30.0444, 31.2357], 16);
                
                layersRef.current.street = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap', maxZoom: 20 });
                layersRef.current.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles © Esri', maxZoom: 19 });
                layersRef.current.labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { attribution: '© CartoDB', pane: 'shadowPane' });

                layersRef.current.satellite.addTo(mapRef.current);
                layersRef.current.labels.addTo(mapRef.current);
            }
            update(ref(db, `drivers/${driver.id}`), { status: isOnline ? 'online' : 'offline' });
        }, [isOnline]);

        // 2. تبديل نوع الخريطة
        React.useEffect(() => {
            if (!mapRef.current) return;
            if (mapType === 'satellite') {
                if(mapRef.current.hasLayer(layersRef.current.street)) mapRef.current.removeLayer(layersRef.current.street);
                if(!mapRef.current.hasLayer(layersRef.current.satellite)) mapRef.current.addLayer(layersRef.current.satellite);
                if(!mapRef.current.hasLayer(layersRef.current.labels)) mapRef.current.addLayer(layersRef.current.labels);
            } else {
                if(mapRef.current.hasLayer(layersRef.current.satellite)) mapRef.current.removeLayer(layersRef.current.satellite);
                if(mapRef.current.hasLayer(layersRef.current.labels)) mapRef.current.removeLayer(layersRef.current.labels);
                if(!mapRef.current.hasLayer(layersRef.current.street)) mapRef.current.addLayer(layersRef.current.street);
            }
        }, [mapType]);

        // 3. استقبال الطلبات
        React.useEffect(() => {
            const requestsRef = ref(db, `requests/${driver.id}`);
            const unsubscribe = onValue(requestsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (data.status === 'waiting_for_price' || data.status === 'price_proposed') {
                        setIncomingRequest(data);
                        updateRoute(data.pickupLat, data.pickupLng, data.dropoffLat, data.dropoffLng);
                    } else if (data.status === 'accepted') {
                        setActiveTrip(data);
                        setIncomingRequest(null);
                        setPriceInput('');
                        setTripStage('pickup');
                        if (currentLocation) updateRoute(currentLocation.lat, currentLocation.lng, data.pickupLat, data.pickupLng, true);
                    } else if (data.status === 'arrived') {
                        setTripStage('arrived');
                    } else if (data.status === 'in_progress') {
                        setTripStage('dropoff');
                        if (currentLocation) updateRoute(currentLocation.lat, currentLocation.lng, data.dropoffLat, data.dropoffLng, true);
                    }
                } else {
                    if (incomingRequest || activeTrip) {
                        setIncomingRequest(null);
                        setActiveTrip(null);
                        clearMap();
                        alert("تم إلغاء أو إنهاء الطلب.");
                    }
                }
            });
            return () => unsubscribe();
        }, [driver.id, activeTrip, currentLocation]);

        // 4. GPS
        React.useEffect(() => {
            if (!navigator.geolocation) return;
            const watchId = navigator.geolocation.watchPosition((pos) => {
                const { latitude, longitude, heading } = pos.coords;
                setCurrentLocation({ lat: latitude, lng: longitude });
                if (!driverMarkerRef.current || !driverMarkerRef.current.dragging?.enabled() || !driverMarkerRef.current.dragging.moving()) {
                    updateDriverMarker(latitude, longitude, heading);
                    if (isOnline) update(ref(db, `drivers/${driver.id}`), { lat: latitude, lng: longitude, status: 'online' });
                }
                if (activeTrip) {
                    if (tripStage === 'pickup') updateRoute(latitude, longitude, activeTrip.pickupLat, activeTrip.pickupLng, true);
                    else if (tripStage === 'dropoff') updateRoute(latitude, longitude, activeTrip.dropoffLat, activeTrip.dropoffLng, true);
                }
            }, (err) => console.warn("GPS Error"), { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
            return () => navigator.geolocation.clearWatch(watchId);
        }, [isOnline, activeTrip, tripStage, driver.photo]); // Added driver.photo dependency

        // --- دوال المساعدة ---
        const updateDriverMarker = (lat, lng, heading) => {
            if (!mapRef.current) return;
            const rotation = heading || 0;
            const iconHtml = `
                <div class="driver-marker-container">
                    <div class="heading-ring" style="transform: rotate(${rotation}deg);">
                        <div class="heading-arrow"></div>
                    </div>
                    <img src="${driver.photo}" class="driver-img">
                </div>
            `;
            const icon = L.divIcon({ className: 'custom-driver-wrapper', html: iconHtml, iconSize: [56, 56], iconAnchor: [28, 28] });

            if (driverMarkerRef.current) {
                 if (!driverMarkerRef.current.dragging?.enabled() || !driverMarkerRef.current.dragging.moving()) driverMarkerRef.current.setLatLng([lat, lng]).setIcon(icon); 
            } else {
                driverMarkerRef.current = L.marker([lat, lng], { icon, draggable: true }).addTo(mapRef.current);
                mapRef.current.setView([lat, lng], 18);
                driverMarkerRef.current.on('dragend', (e) => {
                    const newPos = e.target.getLatLng();
                    setCurrentLocation({lat: newPos.lat, lng: newPos.lng});
                    update(ref(db, `drivers/${driver.id}`), { lat: newPos.lat, lng: newPos.lng, status: isOnline ? 'online' : 'offline' });
                });
            }
        };

        const recenterMap = () => {
            if (currentLocation && mapRef.current) mapRef.current.flyTo([currentLocation.lat, currentLocation.lng], 18);
        };

        const updateRoute = (startLat, startLng, endLat, endLng, isLiveNavigation = false) => {
            if (!mapRef.current) return;
            if (tripMarkersRef.current.start) tripMarkersRef.current.start.remove();
            if (tripMarkersRef.current.end) tripMarkersRef.current.end.remove();

            if (!isLiveNavigation) {
                const pickupIcon = L.divIcon({ className: 'pickup-marker', html: `<div class="w-8 h-8 bg-emerald-500 rounded-full border-2 border-white flex items-center justify-center shadow-lg text-white font-bold text-xs">من</div>`, iconSize: [32, 32] });
                tripMarkersRef.current.start = L.marker([startLat, startLng], { icon: pickupIcon }).addTo(mapRef.current);
            }

            const endIconHtml = `<div class="w-8 h-8 bg-red-500 rounded-full border-2 border-white flex items-center justify-center shadow-lg text-white font-bold text-xs">إلى</div>`;
            const endIcon = L.divIcon({ className: 'dropoff-marker', html: endIconHtml, iconSize: [32, 32] });
            tripMarkersRef.current.end = L.marker([endLat, endLng], { icon: endIcon }).addTo(mapRef.current);

            if (routingControlRef.current) mapRef.current.removeControl(routingControlRef.current);

            routingControlRef.current = L.Routing.control({
                waypoints: [L.latLng(startLat, startLng), L.latLng(endLat, endLng)],
                lineOptions: { styles: [{ color: '#3B82F6', opacity: 0.8, weight: 6 }] },
                createMarker: function() { return null; }, 
                addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: !isLiveNavigation, showAlternatives: false
            }).on('routesfound', function(e) {
                const routes = e.routes;
                setTripInfo({ distance: (routes[0].summary.totalDistance / 1000).toFixed(1), time: Math.round(routes[0].summary.totalTime / 60) });
            }).addTo(mapRef.current);
        };

        const clearMap = () => {
            if (tripMarkersRef.current.start) tripMarkersRef.current.start.remove();
            if (tripMarkersRef.current.end) tripMarkersRef.current.end.remove();
            if (routingControlRef.current) { mapRef.current.removeControl(routingControlRef.current); routingControlRef.current = null; }
            if (currentLocation) recenterMap();
        };

        // --- Actions ---
        const handleProfileSave = (newData) => {
            updateDriverData({ ...driver, ...newData });
            update(ref(db, `drivers/${driver.id}`), newData).then(() => {
                setShowEditProfile(false);
            });
        };

        const sendPriceToClient = () => {
            const price = parseFloat(priceInput);
            if (!incomingRequest || isNaN(price) || price <= 0) return alert("أدخل سعر صحيح");
            update(ref(db, `requests/${driver.id}`), { status: 'price_proposed', finalPrice: price, driverName: driver.name, driverPhoto: driver.photo, driverPlate: driver.plate });
        };

        const handleReject = () => {
            if (window.confirm("هل أنت متأكد من رفض الطلب؟")) {
                remove(ref(db, `requests/${driver.id}`)).then(() => { setIncomingRequest(null); clearMap(); });
            }
        };

        const handleArrivedPickup = () => { update(ref(db, `requests/${driver.id}`), { status: 'arrived' }); setTripStage('arrived'); };
        const handleStartTrip = () => { update(ref(db, `requests/${driver.id}`), { status: 'in_progress' }); setTripStage('dropoff'); if (currentLocation && activeTrip) updateRoute(currentLocation.lat, currentLocation.lng, activeTrip.dropoffLat, activeTrip.dropoffLng, true); };
        
        const completeTrip = () => {
            const price = activeTrip.finalPrice || 50;
            setTotalEarnings(totalEarnings + price);
            update(ref(db, `drivers/${driver.id}`), { totalEarnings: totalEarnings + price });
            remove(ref(db, `requests/${driver.id}`)); 
            setActiveTrip(null); setTripStage('pickup'); clearMap();
            alert(`تم إنهاء الرحلة بنجاح.`);
        };

        return (
            <div className="flex h-screen w-full bg-gray-100 overflow-hidden relative">
                
                {/* Header */}
                <div className="absolute top-4 left-4 right-4 z-[1000]">
                    <div className="glass-header p-3 flex justify-between items-center" onClick={() => setShowEditProfile(true)}>
                        <div className="flex items-center gap-3 cursor-pointer">
                            <div className="relative">
                                <img src={driver.photo} className="w-10 h-10 rounded-full border-2 border-white object-cover shadow-sm" />
                                <div className="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 shadow-sm">
                                    <Icon name="edit-2" size={10} className="text-gray-600" />
                                </div>
                            </div>
                            <div>
                                <div className="font-bold text-sm text-gray-800">{driver.name}</div>
                                <div className="text-xs text-gray-500 font-mono">{driver.plate}</div>
                            </div>
                        </div>
                        <div className="bg-emerald-50 px-3 py-2 rounded-lg text-center border border-emerald-100 shadow-sm">
                            <div className="text-xs text-gray-400">اليوم</div>
                            <div className="font-bold text-emerald-600 text-sm">{totalEarnings} ج.م</div>
                        </div>
                    </div>
                </div>

                {/* Map Controls */}
                <div className="absolute top-24 left-4 z-[1000] flex flex-col gap-2">
                    <button onClick={() => setMapType(mapType === 'street' ? 'satellite' : 'street')} className="map-btn w-10 h-10 flex items-center justify-center">
                        <Icon name={mapType === 'street' ? 'map' : 'globe'} size={20} className="text-gray-700" />
                    </button>
                    <button onClick={recenterMap} className="map-btn w-10 h-10 flex items-center justify-center text-blue-600">
                        <Icon name="crosshair" size={20} />
                    </button>
                </div>

                <div id="map" className="flex-grow w-full h-full bg-gray-300 z-0"></div>

                {/* Footer Panel */}
                <div className="absolute bottom-0 w-full z-[1000]">
                    
                    {/* 1. تفاوض */}
                    {incomingRequest && !activeTrip && (
                        <div className="glass-panel p-5 bottom-sheet-content animate-slide-up">
                            <div className="flex justify-between items-start mb-2">
                                <div className="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded inline-block">طلب تسعير</div>
                                {tripInfo.distance > 0 && <div className="text-xs bg-gray-100 px-2 py-1 rounded font-bold text-gray-600">{tripInfo.distance} كم • {tripInfo.time} د</div>}
                            </div>
                            <h3 className="text-lg font-bold mb-2 text-gray-800">{incomingRequest.clientName}</h3>
                            <div className="flex items-center gap-2 text-sm text-gray-600 mb-4">
                                <span className="w-2 h-2 rounded-full bg-red-500 block"></span>
                                <span>إلى: {incomingRequest.dropoffAddress || "وجهة محددة"}</span>
                            </div>
                            <div className="flex gap-2 mb-4">
                                <input type="number" placeholder="سعر الرحلة" value={priceInput} onChange={(e) => setPriceInput(e.target.value)} className="flex-1 p-3 border rounded-xl bg-gray-50 text-xl text-center font-bold outline-none focus:ring-2 focus:ring-emerald-500" />
                                <span className="text-3xl font-extrabold text-gray-500 self-center">ج.م</span>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={handleReject} className="flex-1 py-3 bg-red-50 text-red-600 rounded-xl font-bold hover:bg-red-100 transition">رفض</button>
                                <button onClick={sendPriceToClient} className="flex-[2] py-3 bg-emerald-600 rounded-xl font-bold text-white shadow-lg">إرسال العرض</button>
                            </div>
                        </div>
                    )}

                    {/* 2. رحلة نشطة */}
                    {activeTrip && (
                        <div className="glass-panel p-5 bottom-sheet-content animate-slide-up border-t-4 border-emerald-500">
                            <div className="flex justify-between items-center mb-4">
                                <div>
                                    <div className="text-xs text-gray-400">
                                        {tripStage === 'pickup' ? 'ذاهب لاستلام العميل' : 
                                         tripStage === 'arrived' ? 'في انتظار العميل' : 'ذاهب للوجهة'}
                                    </div>
                                    <div className="font-bold text-gray-800">{activeTrip.clientName}</div>
                                </div>
                                <div className="font-extrabold text-xl text-emerald-600">{activeTrip.finalPrice} ج.م</div>
                                <a href={`tel:${activeTrip.clientPhone}`} className="w-12 h-12 bg-green-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-green-600"><Icon name="phone" size={24}/></a>
                            </div>

                            {tripStage === 'pickup' && <button onClick={handleArrivedPickup} className="w-full py-4 bg-blue-600 rounded-xl font-bold text-white shadow-lg mb-2">وصلت لموقع العميل</button>}
                            {tripStage === 'arrived' && <button onClick={handleStartTrip} className="w-full py-4 bg-emerald-600 rounded-xl font-bold text-white shadow-lg mb-2">بدء الرحلة (Go)</button>}
                            {tripStage === 'dropoff' && <button onClick={completeTrip} className="w-full py-4 bg-gray-800 rounded-xl font-bold text-white shadow-lg mb-2">إنهاء الرحلة</button>}
                            
                            {tripInfo.distance > 0 && tripStage !== 'arrived' && <div className="text-center text-xs text-gray-500 mt-2">متبقي: {tripInfo.distance} كم ({tripInfo.time} دقيقة)</div>}
                        </div>
                    )}

                    {/* 3. الافتراضي */}
                    {!incomingRequest && !activeTrip && (
                        <div className="p-4">
                            <button onClick={() => setIsOnline(!isOnline)} className={`w-full py-4 rounded-2xl font-extrabold text-lg shadow-xl transition-all flex justify-center items-center gap-2 ${isOnline ? 'bg-emerald-600 text-white' : 'bg-gray-600 text-white'}`}>
                                <Icon name="power" size={24} />
                                {isOnline ? 'أنت متصل (جاهز)' : 'غير متصل'}
                            </button>
                        </div>
                    )}
                </div>

                {/* Modal */}
                {showEditProfile && <EditProfileModal driver={driver} onClose={() => setShowEditProfile(false)} onSave={handleProfileSave} />}
            </div>
        );
    };

    const Login = ({ onLogin }) => {
        const [formData, setFormData] = React.useState({ name: '', phone: '', plate: '' });
        const [img, setImg] = React.useState(null);
        const onImg = (e) => { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=()=>setImg(r.result); r.readAsDataURL(f); }};
        return (
            <div className="h-screen w-full flex items-center justify-center p-4 login-bg relative">
                <div className="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
                <div className="bg-white/95 backdrop-blur-md p-8 rounded-3xl shadow-2xl w-full max-w-md relative z-10">
                    <h1 className="text-2xl font-bold text-center mb-6 text-gray-800">بوابة الكباتن</h1>
                    <div className="relative w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full overflow-hidden border-4 border-gray-200 group cursor-pointer">
                        {img ? <img src={img} className="w-full h-full object-cover"/> : <div className="flex items-center justify-center h-full text-gray-400"><Icon name="camera" size={32}/></div>}
                        <input type="file" onChange={onImg} className="absolute inset-0 opacity-0 cursor-pointer"/>
                    </div>
                    <input placeholder="الاسم ثلاثي" className="w-full p-3 mb-3 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" onChange={e=>setFormData({...formData, name:e.target.value})}/>
                    <input placeholder="الهاتف" className="w-full p-3 mb-3 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" onChange={e=>setFormData({...formData, phone:e.target.value})}/>
                    <input placeholder="رقم اللوحة" className="w-full p-3 mb-6 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" onChange={e=>setFormData({...formData, plate:e.target.value})}/>
                    <button onClick={(e) => { e.preventDefault(); if(formData.name) onLogin({...formData, id: formData.phone.replace(/\D/g,''), photo: img || "https://placehold.co/150x150/000/FFFFFF?text=D", totalEarnings: 0}); }} className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition">دخول</button>
                </div>
            </div>
        );
    };

    const App = () => {
        const [driverData, setDriverData] = React.useState(null);
        React.useEffect(() => { const s = localStorage.getItem('driver_app_real'); if (s) setDriverData(JSON.parse(s)); }, []);
        return driverData ? <Dashboard driver={driverData} updateDriverData={(d) => { setDriverData(d); localStorage.setItem('driver_app_real', JSON.stringify(d)); }} /> : <Login onLogin={(d) => { setDriverData(d); localStorage.setItem('driver_app_real', JSON.stringify(d)); }} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
